<?php
$category_data = null;
function topcategorylist()
  {
  global $wpdb,$category_data;
  $options = "";
  //$options .= "<option value=''>".TXT_WPSC_SELECTACATEGORY."</option>\r\n";
  $values = $wpdb->get_results("SELECT * FROM `".$wpdb->prefix."product_categories` WHERE `active`='1' ORDER BY `id` ASC",ARRAY_A);
  $url = "http://".$_SERVER['SERVER_NAME'].$_SERVER['SCRIPT_NAME']."?page=wp-shopping-cart/display-items.php";
  $options .= "<option value='$url'>".TXT_WPSC_ALLCATEGORIES."</option>\r\n";
  if($values != null)
    {
    foreach($values as $option)
      {
      $category_data[$option['id']] = $option['name'];
      if($_GET['catid'] == $option['id'])
        {
        $selected = "selected='selected'";
        }
      $options .= "<option $selected value='$url&amp;catid=".$option['id']."'>".$option['name']."</option>\r\n";
      $selected = "";
      }
    }
  $concat .= "<select name='category' onChange='categorylist(this.options[this.selectedIndex].value)'>".$options."</select>\r\n";
  return $concat;
  }

function brandslist($current_brand = '')
  {
  global $wpdb;
  $options = "";
  $options .= "<option  $selected value='0'>".TXT_WPSC_SELECTABRAND."</option>\r\n";
  $values = $wpdb->get_results("SELECT * FROM `".$wpdb->prefix."product_brands` WHERE `active`='1' ORDER BY `id` ASC",ARRAY_A);
  foreach($values as $option)
    {
    if($curent_category == $option['id'])
      {
      $selected = "selected='selected'";
       }
    $options .= "<option  $selected value='".$option['id']."'>".$option['name']."</option>\r\n";
    $selected = "";
    }
  $concat .= "<select name='brand'>".$options."</select>\r\n";
  return $concat;
  }
  
function variationslist($current_variation = '')
    {
    global $wpdb;
    $options = "";
    //$options .= "<option value=''>".TXT_WPSC_SELECTACATEGORY."</option>\r\n";
    $values = $wpdb->get_results("SELECT * FROM `".$wpdb->prefix."product_variations` ORDER BY `id` ASC",ARRAY_A);
    $options .= "<option  $selected value='0'>".TXT_WPSC_SELECTAVARIATION."</option>\r\n";
    //$options .= "<option  $selected value='add'>".TXT_WPSC_NEW_VARIATION."</option>\r\n";
    if($values != null)
      {
      foreach($values as $option)
        {
        if($current_brand == $option['id'])
          {
          $selected = "selected='selected'";
          }
        $options .= "<option  $selected value='".$option['id']."'>".$option['name']."</option>\r\n";
        $selected = "";
        }
      }
    $concat .= "<select name='variations' onChange='add_variation_value_list(this.options[this.selectedIndex].value)'>".$options."</select>\r\n";
    return $concat;
    }

if($_POST['submit_action'] == 'add')
  {  
  //exit(nl2br(print_r($_POST,true)));
  $basepath =  str_replace("/wp-admin", "" , getcwd());
  $imagedir = $basepath."/wp-content/plugins/wp-shopping-cart/images/";
  $product_images = $basepath."/wp-content/plugins/wp-shopping-cart/product_images/";
  $filedir = $basepath."/wp-content/plugins/wp-shopping-cart/files/";
  $preview_clips_dir = $basepath."/wp-content/plugins/wp-shopping-cart/preview_clips/";
  $image = '';

  if($_FILES['image'] != null)
    {
    if(!is_dir($product_images))
      {
      mkdir($product_images);
      }
    if(function_exists("getimagesize"))
      {
      switch($_POST['image_resize'])
        {
        case 1:
        $height = get_option('product_image_height');
        $width  = get_option('product_image_width');
        break;

        case 2:
        $height = $_POST['height'];
        $width  = $_POST['width'];
        break;
        }
      copy($_FILES['image']['tmp_name'], $product_images.$_FILES['image']['name']);
      include("image_processing.php");
      }
      else
        {
        move_uploaded_file($_FILES['image']['tmp_name'], ($imagedir.$_FILES['image']['name']));
        $image = $wpdb->escape($_FILES['image']['name']);
        }
    }
    else
      {
      $image = '';
      }
  if($_FILES['file']['name'] != null)
    {
    $timestamp = time();
    $wpdb->query("INSERT INTO `".$wpdb->prefix."product_files` ( `id` , `filename`  , `mimetype` , `idhash` , `date` ) VALUES ( '' , '', '', '', '$timestamp');");
    $fileid_raw = $wpdb->get_results("SELECT `id` FROM `".$wpdb->prefix."product_files` WHERE `date` = '$timestamp'",ARRAY_A);
    $fileid = $fileid_raw[0]['id'];
    $idhash = sha1($fileid);
    $mimetype = $_FILES['file']['type'];
    $splitname = explode(".",$_FILES['file']['name']);
    $splitname = array_reverse($splitname);
    $filename = $_FILES['file']['name'];
    if(move_uploaded_file($_FILES['file']['tmp_name'],($filedir.$idhash)))
      {
      if(function_exists("make_mp3_preview"))
        {
        if(!is_dir($preview_clips_dir))
          {
          mkdir($preview_clips_dir);
          }
        make_mp3_preview(($filedir.$idhash), ($preview_clips_dir.$idhash.".mp3"));
        }
      $wpdb->query("UPDATE `".$wpdb->prefix."product_files` SET `filename` = '".$filename."', `mimetype` = '$mimetype', `idhash` = '$idhash' WHERE `id` = '$fileid' LIMIT 1");
      }
    $file = $fileid;
    }
    else
      {
      $file = '0';
      }
   if($_POST['special'] == 'yes')
     {
     $special = 1;
     if(is_numeric($_POST['special_price']))
       {
       $special_price = $_POST['price'] - $_POST['special_price'];
       }
     }
     else
       {
       $special = 0;
       $special_price = '';
       }
       
   if($_POST['notax'] == 'yes')
     {
     $notax = 1;
     }
     else
       {
       $notax = 0;
       }
   
   if(is_numeric($_POST['quantity']) && ($_POST['quantity_limited'] == "yes"))
     {
     $quantity_limited = 1;
     $quantity = $_POST['quantity'];
     }
     else
       {
       $quantity_limited = 0;
       $quantity = 0;
       }
   
   if($_POST['display_frontpage'] == "yes")
     {
     $display_frontpage = 1;
     }
     else
       {
       $display_frontpage = 0;
       }
       
  $insertsql = "INSERT INTO `".$wpdb->prefix."product_list` ( `id` , `name` , `description` , `additional_description` , `price` , `pnp`, `international_pnp`, `file` , `image` , `category`, `brand`, `quantity_limited`, `quantity`, `special`, `special_price`,`notax` ) VALUES ('', '".$wpdb->escape($_POST['name'])."', '".$wpdb->escape($_POST['description'])."', '".$wpdb->escape($_POST['additional_description'])."','".$wpdb->escape(str_replace(",","",$_POST['price']))."', '".$wpdb->escape($_POST['pnp'])."', '".$wpdb->escape($_POST['international_pnp'])."', '".$file."', '".$image."', '".$wpdb->escape($_POST['category'])."', '".$wpdb->escape($_POST['brand'])."', '$quantity_limited','$quantity','$special','$special_price','$notax');";
  //echo $insertsql;
  if($wpdb->query($insertsql))
    {
    $product_id_data = $wpdb->get_results("SELECT LAST_INSERT_ID() AS `id` FROM `".$wpdb->prefix."product_list` LIMIT 1",ARRAY_A);
    $product_id = $product_id_data[0]['id'];
  
  if(($_FILES['extra_image'] != null) && function_exists('edit_submit_extra_images'))
    {
    $var = edit_submit_extra_images($product_id);
    }
  
  $variations_procesor = new nzshpcrt_variations;
  if($_POST['variation_values'] != null)
    {
    $variations_procesor->add_to_existing_product($product_id,$_POST['variation_values']); 
    }
  
  $counter = 0;
  $item_list = '';
  if(count($_POST['category']) > 0)
    {
    foreach($_POST['category'] as $category_id)
      {
      $check_existing = $wpdb->get_var("SELECT `id` FROM `".$wpdb->prefix."item_category_associations` WHERE `product_id` = ".$product_id." AND `category_id` = '$category_id' LIMIT 1");
      if($check_existing == null)
        {
        $wpdb->query("INSERT INTO `".$wpdb->prefix."item_category_associations` ( `id` , `product_id` , `category_id` ) VALUES ('', '".$product_id."', '".$category_id."');");        
        }
      }
    }
  
  $display_added_product = "filleditform(".$product_id.");";
  
  echo "<div class='updated'><p align='center'>".TXT_WPSC_ITEMHASBEENADDED."</p></div>";
  }
  else
    {
    echo "<div class='updated'><p align='center'>".TXT_WPSC_ITEMHASNOTBEENADDED."</p></div>";
    }
 }

if($_GET['submit_action'] == "remove_set")
  {
  if(is_numeric($_GET['product_id']) && is_numeric($_GET['variation_assoc_id']))
    {
    $product_id = $_GET['product_id'];
    $variation_assoc_id = $_GET['variation_assoc_id'];
    $variation_association = $wpdb->get_results("SELECT * FROM `".$wpdb->prefix."variation_associations` WHERE `id` = '$variation_assoc_id' LIMIT 1",ARRAY_A);
    if($variation_association != null)
      {
      $variation_association = $variation_association[0];
      $variation_id = $variation_association['variation_id'];
      $delete_variation_sql = "DELETE FROM `".$wpdb->prefix."variation_associations` WHERE `id` = '$variation_assoc_id' LIMIT 1";
      $delete_value_sql = "DELETE FROM `".$wpdb->prefix."variation_values_associations` WHERE `product_id` = '$product_id' AND `variation_id` = '$variation_id'";
      $wpdb->query($delete_variation_sql);
      $wpdb->query($delete_value_sql);
      echo "<div class='updated'><p align='center'>".TXT_WPSC_PRODUCTHASBEENEDITED."</p></div>";
      }
    } 
  }

if($_POST['submit_action'] == "edit")
  {
  //exit("<pre>".print_r($_POST,true)."</pre>");
  $id = $_POST['prodid'];
  if(function_exists('edit_submit_extra_images'))
    {
    if(($_FILES['extra_image'] != null))
      {
      $var = edit_submit_extra_images($id);
      }
    }
  if(function_exists('edit_extra_images'))
    {
    $var = edit_extra_images($id);
    }
  $basepath =  str_replace("/wp-admin", "" , getcwd());
  $imagedir = $basepath."/wp-content/plugins/wp-shopping-cart/images/";
  $product_images = $basepath."/wp-content/plugins/wp-shopping-cart/product_images/";
  $filedir = $basepath."/wp-content/plugins/wp-shopping-cart/files/";
  $preview_clips_dir = $basepath."/wp-content/plugins/wp-shopping-cart/preview_clips/";
  
  
  if($_FILES['file']['name'] != null)
    {
    $id = $_POST['prodid'];
    $fileid_data = $wpdb->get_results("SELECT `file` FROM `".$wpdb->prefix."product_list` WHERE `id` = '$id' LIMIT 1",ARRAY_A);
    $fileid = $fileid_data[0]['file'];
    $file_data = $wpdb->get_results("SELECT `id`,`idhash` FROM `".$wpdb->prefix."product_files` WHERE `id` = '$fileid' LIMIT 1",ARRAY_A);
    $idhash = $file_data[0]['idhash'];
    $mimetype = $_FILES['file']['type'];
    //exit($mimetype);
    $filename = $_FILES['file']['name'];
    if(move_uploaded_file($_FILES['file']['tmp_name'],($filedir.$idhash)))
      {
      if(function_exists("make_mp3_preview") && ($mimetype == 'audio/mpeg'))
        {
        if(!is_dir($preview_clips_dir))
          {
          mkdir($preview_clips_dir);
          }
        make_mp3_preview(($filedir.$idhash), ($preview_clips_dir.$idhash.".mp3"));
        }
      $wpdb->query("UPDATE `".$wpdb->prefix."product_files` SET `filename` = '".$filename."', `mimetype` = '$mimetype' WHERE `id` = '".$file_data[0]['id']."' LIMIT 1");
      }
    }

  if($_FILES['image'] != null)
    {
    if(!is_dir($product_images))
      {
      mkdir($product_images);
      }
    if(function_exists("getimagesize"))
      {
      switch($_POST['image_resize'])
        {
        case 1:
        $height = get_option('product_image_height');
        $width  = get_option('product_image_width');
        break;
  
        case 2:
        $height = $_POST['height'];
        $width  = $_POST['width'];
        break;
        }
      copy($_FILES['image']['tmp_name'], ($product_images.$_FILES['image']['name']));
      include("image_processing.php");
      }
      else
        {
        move_uploaded_file($_FILES['image']['tmp_name'], ($imagedir.$_FILES['image']['name']));
        $image = $wpdb->escape($_FILES['image']['name']);
        }
    }
    else
      {
      $image = '';
      }

  if(is_numeric($_POST['prodid']))
    {
    if(($_POST['image_resize'] > 0) && ($image === ''))
      {
      $imagesql = "SELECT `image` FROM `".$wpdb->prefix."product_list` WHERE `id`=".$_POST['prodid']." LIMIT 1";
      $imagedata = $wpdb->get_results($imagesql,ARRAY_A);
      if($imagedata[0]['image'] != '')
        {
        $imagepath = $imagedir . $imagedata[0]['image'];
        switch($_POST['image_resize'])
          {
          case 1:
          $height = get_option('product_image_height');
          $width  = get_option('product_image_width');
          break;
  
          case 2:
          $height = $_POST['height'];
          $width  = $_POST['width'];
          break;
          }
        include("image_resize.php");
        }
      }
    
    if(is_numeric($_POST['prodid']))
      {
      $counter = 0;
      $item_list = '';
      if(count($_POST['category']) > 0)
        {
        foreach($_POST['category'] as $category_id)
          {
          $check_existing = $wpdb->get_var("SELECT `id` FROM `".$wpdb->prefix."item_category_associations` WHERE `product_id` = ".$id." AND `category_id` = '$category_id' LIMIT 1");
          if($check_existing == null)
            {
            $wpdb->query("INSERT INTO `".$wpdb->prefix."item_category_associations` ( `id` , `product_id` , `category_id` ) VALUES ('', '".$id."', '".$category_id."');");        
            }
          if($counter > 0)
            {
            $item_list .= ", ";
            }
          $item_list .= "'".$category_id."'";
          $counter++;
          }
        }
        else
          {
          $item_list = "'0'";
          }
      $wpdb->query("DELETE FROM `".$wpdb->prefix."item_category_associations` WHERE `product_id`= '$id' AND `category_id` NOT IN (".$item_list.")"); 
      }
    
   if(is_numeric($_POST['quantity']) && ($_POST['quantity_limited'] == "yes"))
     {
     //exit("<pre>".print_r($_POST,true)."</pre>");
     $quantity_limited = 1;
     $quantity = $_POST['quantity'];
     }
     else
       {
       $quantity_limited = 0;
       $quantity = 0;
       }
       
    if($_POST['special'] == 'yes')
      {
      $special = 1;
     if(is_numeric($_POST['special_price']))
       {
       $special_price = $_POST['price'] - $_POST['special_price'];
       }
      }
      else
        {
        $special = 0;
        $special_price = '';
        }
  
    if($_POST['notax'] == 'yes')
      {
      $notax = 1;
      }
      else
        {
        $notax = 0;
        }

      
   if($_POST['display_frontpage'] == "yes")
     {
     $display_frontpage = 1;
     }
     else
       {
       $display_frontpage = 0;
       }
             
      $updatesql = "UPDATE `".$wpdb->prefix."product_list` SET `name` = '".$wpdb->escape($_POST['title'])."', `description` = '".$wpdb->escape($_POST['description'])."', `additional_description` = '".$wpdb->escape($_POST['additional_description'])."', `price` = '".$wpdb->escape(str_replace(",","",$_POST['price']))."', `pnp` = '".$wpdb->escape($_POST['pnp'])."', `international_pnp` = '".$wpdb->escape($_POST['international_pnp'])."', `category` = '".$wpdb->escape($_POST['category'])."', `brand` = '".$wpdb->escape($_POST['brand'])."', quantity_limited = '".$quantity_limited."', `quantity` = '".$quantity."', `special`='$special', `special_price`='$special_price', `display_frontpage`='$display_frontpage', `notax`='$notax'  WHERE `id`='".$_POST['prodid']."' LIMIT 1";
      //exit("<pre>".print_r($updatesql,true)."</pre>");
      $wpdb->query($updatesql);
      if($image != null)
        {
        $updatesql2 = "UPDATE `".$wpdb->prefix."product_list` SET `image` = '".$image."' WHERE `id`='".$_POST['prodid']."' LIMIT 1";
        $wpdb->query($updatesql2);
        }
      if($_POST['deleteimage'] == 1)
        {
        $updatesql2 = "UPDATE `".$wpdb->prefix."product_list` SET `image` = ''  WHERE `id`='".$_POST['prodid']."' LIMIT 1";
        $wpdb->query($updatesql2);
        }
        
        
     
     $variations_procesor = new nzshpcrt_variations;
     if($_POST['variation_values'] != null)
       {
       $variations_procesor->add_to_existing_product($_POST['prodid'],$_POST['variation_values']); 
       }
     
     if($_POST['edit_variation_values'] != null)
       {
       $variations_procesor->edit_product_values($_POST['prodid'],$_POST['edit_variation_values']);
       }
     
     if($_POST['edit_add_variation_values'] != null)
       {
       $variations_procesor->edit_add_product_values($_POST['prodid'],$_POST['edit_add_variation_values']);
       }
     
     echo "<div class='updated'><p align='center'>".TXT_WPSC_PRODUCTHASBEENEDITED."</p></div>";
     }
  }

if(is_numeric($_GET['deleteid']))
  {
  $deletesql = "UPDATE `".$wpdb->prefix."product_list` SET  `active` = '0' WHERE `id`='".$_GET['deleteid']."' LIMIT 1";
  $wpdb->query($deletesql);
  }
  
  
/*
 * Gets the product list, commented to make it stick out more, as it is hard to notice 
 */
if(is_numeric($_GET['catid']))
  {
  // if we are getting items from only one category
  $sql = "SELECT `".$wpdb->prefix."product_list`.*,`".$wpdb->prefix."item_category_associations`.`category_id` AS `category_id` FROM `".$wpdb->prefix."product_list`, `".$wpdb->prefix."item_category_associations`  WHERE `".$wpdb->prefix."product_list`.`active`='1' AND `".$wpdb->prefix."product_list`.`id` = `".$wpdb->prefix."item_category_associations`.`product_id` AND `".$wpdb->prefix."item_category_associations`.`category_id`='".$_GET['catid']."'";
  }
  else
    {
    // if not, get everything that is not deleted (denoted by the active column, 1 = present, 0 = deleted, no real deletion because that would screw up the product log)
    $sql = "SELECT `".$wpdb->prefix."product_list`.*,`".$wpdb->prefix."item_category_associations`.`category_id` AS `category_id` FROM `".$wpdb->prefix."product_list`, `".$wpdb->prefix."item_category_associations`  WHERE `".$wpdb->prefix."product_list`.`active`='1' AND `".$wpdb->prefix."product_list`.`id` = `".$wpdb->prefix."item_category_associations`.`product_id`";
    }
$product_list = $wpdb->get_results($sql,ARRAY_A) ;
/*
 * The product list is stored in $product_list now
 */
?>


<div class="wrap">
  <h2><?php echo TXT_WPSC_DISPLAYPRODUCTS;?></h2>
  <a href='' onclick='return showaddform()' class='add_item_link'><img src='../wp-content/plugins/wp-shopping-cart/images/package_add.png' alt='<?php echo TXT_WPSC_ADD; ?>' title='<?php echo TXT_WPSC_ADD; ?>' />&nbsp;<span><?php echo TXT_WPSC_ADDPRODUCT;?></span></a><br />
  <?php echo TXT_WPSC_PLEASESELECTACATEGORY;?>:
  <?php
  echo topcategorylist() . " <span id='loadingindicator_span'><img id='loadingimage' src='../wp-content/plugins/wp-shopping-cart/images/indicator.gif' alt='Loading' title='Loading' /></span><br /><br />";
  ?>
  <script language='javascript' type='text/javascript'>
function conf()
  {
  var check = confirm("<?php echo TXT_WPSC_SURETODELETEPRODUCT;?>");
  if(check)
    {
    return true;
  }
  else
    {
    return false;
    }
  }
<?php
if(is_numeric($_POST['prodid']))
  {
  echo "filleditform(".$_POST['prodid'].");";
  }
  else if(is_numeric($_GET['product_id']))
    {
    echo "filleditform(".$_GET['product_id'].");";
    }
  
echo $display_added_product ;
?>
</script>
  <?php
  

$num = 0;

echo "    <table id='productpage'>\n\r";
echo "      <tr><td>\n\r";
echo "        <table id='itemlist'>\n\r";
echo "          <tr>\n\r";
echo "            <td colspan='6' style='text-align: left;'>\n\r";
echo "<strong class='form_group'>".TXT_WPSC_SELECT_PRODUCT."</strong>";
echo "            </td>\n\r";
echo "          </tr>\n\r";
echo "          <tr class='firstrow'>\n\r";

echo "            <td>\n\r";
echo TXT_WPSC_IMAGE;
echo "            </td>\n\r";

echo "            <td>\n\r";
echo TXT_WPSC_NAME;
echo "            </td>\n\r";
/*
echo "            <td>\n\r";
echo TXT_WPSC_DESCRIPTION;
echo "            </td>\n\r";
*/
echo "            <td>\n\r";
echo TXT_WPSC_STOCK;
echo "            </td>\n\r";

echo "            <td>\n\r";
echo TXT_WPSC_PRICE;
echo "            </td>\n\r";
/*
echo "            <td>\n\r";
echo TXT_WPSC_PNP;
echo "            </td>\n\r";
*/
echo "            <td>\n\r";
echo TXT_WPSC_CATEGORY;
echo "            </td>\n\r";
/*
echo "            <td>\n\r";
echo TXT_WPSC_BRAND;
echo "            </td>\n\r";
*/
echo "            <td>\n\r";
echo TXT_WPSC_EDIT;
echo "            </td>\n\r";

echo "          </tr>\n\r";
if($product_list != null)
  {
  foreach($product_list as $product)
    {
    echo "          <tr>\n\r";
    echo "            <td>\n\r";
    $basepath =  str_replace("/wp-admin", "" , getcwd());
    $imagedir = $basepath."/wp-content/plugins/wp-shopping-cart/images/";
    if(file_exists($imagedir.$product['image']))
      {
      echo "<img src='../wp-content/plugins/wp-shopping-cart/images/".$product['image']."' title='".$product['name']."' alt='".$product['name']."' width='35' height='35' />";
      }
      else
        {
        echo "<img src='../wp-content/plugins/wp-shopping-cart/no-image-uploaded.gif' title='".$product['name']."' alt='".$product['name']."' width='35' height='35'  />";
          }
    echo "            </td>\n\r";
    
    echo "            <td>\n\r";
    echo "".stripslashes($product['name'])."";
    echo "            </td>\n\r";
    
    echo "            <td>\n\r";
    if($product['quantity_limited'] == 1)
      {
      echo "".stripslashes($product['quantity'])."";
      }
      else
        {
        echo "N/A";
        }
    echo "            </td>\n\r";
    
    
    echo "            <td>\n\r";
    echo nzshpcrt_currency_display($product['price'], 1);
    echo "            </td>\n\r";
    /*
    echo "            <td>\n\r";
    echo nzshpcrt_currency_display($product['pnp'], 1);
    echo "            </td>\n\r";
    */
    
    echo "            <td>\n\r";
    echo "".$category_data[$product['category_id']]."";
    echo "            </td>\n\r";
    /*
    echo "            <td>\n\r";
    //echo "".$brand_data[$product['brands']]."";
    echo "".print_r($brand_data,true)."";
    echo "            </td>\n\r";
    */
    echo "            <td>\n\r";
    echo "<a href='#' onclick='filleditform(".$product['id'].");return false;'>".TXT_WPSC_EDIT."</a>";
    echo "            </td>\n\r";
    
    echo "          </tr>\n\r";
    }
  }
echo "        </table>\n\r";
echo "      </td><td class='secondcol'>\n\r";
echo "        <div id='productform'>";
echo "<form method='POST'  enctype='multipart/form-data' name='editproduct$num'>";
echo "        <table class='producttext'>\n\r";;    

echo "          <tr>\n\r";
echo "            <td colspan='2'>\n\r";
//echo "<strong>".TXT_WPSC_EDITITEM."</strong>";
echo "<strong class='form_group'>".TXT_WPSC_PRODUCTDETAILS." <span>".TXT_WPSC_ENTERPRODUCTDETAILSHERE."</span></strong>";
echo "            </td>\n\r";
echo "          </tr>\n\r";

echo "        </table>\n\r";
echo "        <div id='formcontent'>\n\r";
echo "        </div>\n\r";
echo "</form>";
echo "        </div>";
?>
<div id='additem'>
  <form method='POST' enctype='multipart/form-data'>
  <table class='additem'>
    <tr>
      <td colspan='2'>
        <strong class='form_group'><?php echo TXT_WPSC_PRODUCTDETAILS;?> <span><?php echo TXT_WPSC_ENTERPRODUCTDETAILSHERE;?></span></strong>
      </td>
    </tr>
    <tr>
      <td class='itemfirstcol'>
        <?php echo TXT_WPSC_PRODUCTNAME;?>:
      </td>
      <td>
        <input size='30' type='text' name='name' value=''  />
      </td>
    </tr>
    <tr>
      <td class='itemfirstcol'>
        <?php echo TXT_WPSC_PRODUCTDESCRIPTION;?>:
      </td>
      <td>
        <textarea name='description' cols='40' rows='8'></textarea><br />
      </td>
    </tr>
    <tr>
      <td class='itemfirstcol'>
       <?php echo TXT_WPSC_ADDITIONALPRODUCTDESCRIPTION;?>:
      </td>
      <td>
        <textarea name='additional_description' cols='40' rows='8'></textarea><br />
      </td>
    </tr>
    <tr>
      <td rowspan='2'>
       <?php echo TXT_WPSC_PRICE;?>:
      </td>
      <td>
        <input type='text' size='10' name='price' value='0.00' />
      </td>
    </tr>
    <tr>
       <td>
          <input id='form_tax' type='checkbox' name='notax' value='yes' />&nbsp;<label for='form_tax'><?php echo TXT_WPSC_TAXALREADYINCLUDED;?></label>
       </td>
    </tr>
    <tr>
      <td>
      </td>
      <td>
        <input type="checkbox" onclick="hideelement('add_special')" value="yes" name="special" id="form_special"/>
        <label for="form_special"><?php echo TXT_WPSC_SPECIAL;?></label>
        <div style="display: none;" id="add_special">
          <input type="text" size="10" value="0.00" name="special_price"/>
        </div>
      </td>
    </tr>
    <tr>
      <td>
        <?php echo TXT_WPSC_PRODUCTSTOCK;?>:
      </td>
      <td>
        <input type="checkbox" onclick="hideelement('add_stock')" value="yes" name="quantity_limited"/>
        <span class="small"><?php echo TXT_WPSC_UNTICKBOX;?></span>
        <div style="display: none;" id="add_stock">
          <input type='text' name='quantity' value='0' size='10' />
        </div>
      </td>
    </tr>
  
    <tr>
      <td>
        <?php echo TXT_WPSC_CHOOSEACATEGORY;?>:
      </td>
      <td>
        <?php echo categorylist(); ?>
      </td>
    </tr>
    <tr>
      <td>
        <?php echo TXT_WPSC_CHOOSEABRAND;?>:
      </td>
      <td>
        <?php echo brandslist(); ?>
      </td>
    </tr>
    <tr>
      <td>
        <?php echo TXT_WPSC_DISPLAY_FRONT_PAGE;?>:
      </td>
      <td>
        <input type="checkbox" value="yes" name="display_frontpage"/>
      </td>
    </tr>

    <tr>
      <td colspan='2'>
        <strong class='form_group'><?php echo TXT_WPSC_SHIPPING_DETAILS; ?></strong>
      </td>
    </tr>
  
    <tr>
      <td>
      <?php echo TXT_WPSC_LOCAL_PNP; ?> 
      </td>
      <td>
        <input type='text' size='10' name='pnp' value='0.00' />
      </td>
    </tr>
  
    <tr>
      <td>
      <?php echo TXT_WPSC_INTERNATIONAL_PNP; ?>
      </td>
      <td>
        <input type='text' size='10' name='international_pnp' value='0.00' />
      </td>
    </tr>


    <tr>
      <td colspan='2'>
      <br /><strong class='form_group'><?php echo TXT_WPSC_PRODUCT_VARS; ?></strong>
      </td>
    </tr>
    <tr>
      <td>
        <?php echo TXT_WPSC_ADD_VAR; ?>
      </td>
      <td>
        <?php echo variationslist(); ?>
        <div id='add_product_variations'>
        
        </div>
      </td>
    </tr> 
    
    <tr>
      <td colspan='2'>
        <br />
        <strong class='form_group'><?php echo TXT_WPSC_PRODUCTIMAGES;?></strong>
      </td>
    </tr>
    <tr>
      <td>
        <?php echo TXT_WPSC_PRODUCTIMAGE;?>:
      </td>
      <td>
        <input type='file' name='image' value='' />
      </td>
    </tr>
    
<?php
if(function_exists("getimagesize") && is_numeric(get_option('product_image_height')) && is_numeric(get_option('product_image_width')))
  {
  ?>
    <tr>
      <td>
      </td>
      <td>
        <input type='radio' checked='true' name='image_resize' value='1' id='image_resize1' class='image_resize' /> <label for='image_resize1'><?php echo TXT_WPSC_USEDEFAULTHEIGHTANDWIDTH;?> (<?php echo get_option('product_image_height') ."x".get_option('product_image_width'); ?>)</label>
      </td>
    </tr>
  <?php  
  $default_size_set = true;
  }

if(function_exists("getimagesize"))
  {
  ?>
    <tr>
      <td>
      </td>
      <td>
        <input type='radio' name='image_resize' value='2' id='image_resize2' class='image_resize'  />
        <label for='image_resize2'><?php echo TXT_WPSC_USE;?> </label><input onclick='checkimageresize()' type='text' size='4' name='height' value='' /><label for='image_resize2'><?php echo TXT_WPSC_PXHEIGHTBY;?> </label><input onclick='checkimageresize()' type='text' size='4' name='width' value='' /><label for='image_resize2'><?php echo TXT_WPSC_PXWIDTH;?></label>
      </td>
    </tr>
  <?php
  }

if(function_exists('add_multiple_image_form'))
  {
  echo add_multiple_image_form(); 
  }
?>
    <tr>
      <td colspan='2'>
        <br />
        <strong class='form_group'><?php echo TXT_WPSC_PRODUCTDOWNLOAD;?></strong>
      </td>
    </tr>
    <tr>
      <td>
        <?php echo TXT_WPSC_DOWNLOADABLEPRODUCT;?>?:
      </td>
      <td>
        <input type='file' name='file' value='' /> <span class='small'><br /><?php echo TXT_WPSC_FILETOBEPRODUCT;?></span><br /><br />
      </td>
    </tr>
    <tr>
      <td>
      </td>
      <td>
        <input type='hidden' name='submit_action' value='add' />
        <input type='submit' name='submit' value='<?php echo TXT_WPSC_ADD;?>' />
      </td>
    </tr>
  </table>
  </form>
  </div>
<?php
echo "      </td></tr>\n\r";
echo "     </table>\n\r"

  ?>
</div>